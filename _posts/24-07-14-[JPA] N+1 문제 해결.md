--- 
layout: post 
categories: [JPA]
tags: [JPA, N+1, TroubleShooting ]
---



ì´ì „ì— í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ë°œìƒí–ˆë˜ ë¬¸ì œë¥¼ ì •ë¦¬í•˜ê¸° ìœ„í•´ ì‘ì„±í•œë‹¤.
íŒ€ í”„ë¡œì íŠ¸ì—ì„œ QnA ê²Œì‹œíŒì„ ë§¡ì•„ì„œ ê°œë°œí•˜ê²Œë˜ì—ˆë‹¤.
QnA ê²Œì‹œíŒì€ ê²Œì‹œê¸€ì„ ì‘ì„±í•  ë•Œ í•´ì‹œíƒœê·¸ë¥¼ í•¨ê»˜ ì‘ì„± í•  ìˆ˜ìˆê³  ê²Œì‹œê¸€ì— ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. ê°ê°ì˜ í…Œì´ë¸”ì˜ ê´€ê³„ë¥¼ ì‚´í´ë³´ë©´

![Untitled](/assets/img/JPA/n+1(1).png)

<br>

í•˜ë‚˜ì˜ ê²Œì‹œê¸€ì€ ì—¬ëŸ¬ê°œì˜ ëŒ“ê¸€ì„ ê°€ì§ˆ ìˆ˜ ìˆì–´ 1:N ê´€ê³„ë¥¼ ê°€ì§„ë‹¤.
<br>

Question.class

```java
public class Question {
	
	// ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ìƒëµ
		
	@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
	private List<QuestionHashTag> tagList = new ArrayList<>();
	
	@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
	private List<Comment> commentList;

}
```

<br>

Comment.class
```java
public class Comment {

// .. ìƒëµ

  @ManyToOne
  @JoinColumn(name = "QUESTION_NO", nullable = false)
  private Question question;

}
```

<br><br>


![Untitled](/assets/img/JPA/n+1(2).png)

í•˜ë‚˜ì˜ ê²Œì‹œê¸€ì€ ì—¬ëŸ¬ê°œì˜ í•´ì‹œíƒœê·¸ë¥¼ ê°€ì§ˆìˆ˜ ìˆê³  í•˜ë‚˜ì˜ í•´ì‹œíƒœê·¸ëŠ” ì—¬ëŸ¬ê°œì˜ ê²Œì‹œê¸€ì— ì‚¬ìš©ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í•´ì‹œíƒœê·¸ì™€ ê²Œì‹œê¸€ì€ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ê°€ì§„ë‹¤.

<br>

Question.class
```java
public class Question {
	
	// ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ìƒëµ
		
	@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
	private List<QuestionHashTag> tagList = new ArrayList<>();
	
	@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
	private List<Comment> commentList;

}
```

<br>

QuestionHashTag.class

```java
public class QuestionHashTag {

//.. ìƒëµ

  @ManyToOne
  @JoinColumn(name = "question_no")
  private Question question;

  @ManyToOne
  @JoinColumn(name = "hashtag_no")
  private HashTag hashTag;
}
```

<br>

HashTag.class

```java
public class HashTag {

//.. ìƒëµ

  @OneToMany(mappedBy = "hashTag" ,cascade=CascadeType.ALL , orphanRemoval = true)
  private List<QuestionHashTag> questions;

}
```


<br>

`@ManyToMany` ë¥¼ ì‚¬ìš©í•´ ê´€ê³„ë¥¼ ë§ºì„ ìˆ˜ ìˆì§€ë§Œ ì¶”í›„ì— ë°ì´í„°(ì˜ˆ í•´ì‹œíƒœê·¸ê°€ ë“±ë¡ëœ ì‹œê°„) ì¶”ê°€ë¥¼ í•  ìˆ˜ ì—†ë‹¤ëŠ” ë‹¨ì ì´ ìˆì–´ ì¤‘ê°„ í…Œì´ë¸”ì„ ìƒì„±í•´ `@OneToMany`ì™€ `@ManyToOne`ìœ¼ë¡œ ê´€ê³„ë¥¼ í’€ì–´ëƒˆë‹¤.


<br>
<br>








## ë¬¸ì œ ë°œìƒ

ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ ê¸°ëŠ¥ì„ ê°œë°œí• ë•Œ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.
ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒí• ë•Œ í•„ìš”í•œ ì •ë³´ë“¤ì€ ê²Œì‹œê¸€ì˜ ì •ë³´(ì œëª©, ë‚´ìš©, ì‘ì„±ì, ì¡°íšŒìˆ˜, ì‘ì„±ë‚ ì§œ ë“±)ì™€ ëŒ“ê¸€ì˜ ê°¯ìˆ˜ ê·¸ë¦¬ê³  í•´ì‹œíƒœê·¸ì˜ ì´ë¦„ì´ í•„ìš”í•˜ë‹¤.

![Untitled](/assets/img/JPA/n+1(3).png)

ê²Œì‹œê¸€ ì¡°íšŒê¸°ëŠ¥ì„ ê°œë°œí•˜ê³  hibernateì˜ show_sql ì†ì„±ì„ ì‚¬ìš©í•´ JPAê°€ ë§Œë“¤ì–´ì£¼ëŠ” SQLë¬¸ì„ í™•ì¸í•´ë³´ë‹ˆ ê²Œì‹œê¸€ ì¡°íšŒì‹œ ìƒê°ë³´ë‹¤ ë„ˆë¬´ ë§ì€ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ëŠ”ê²ƒì„ ë°œê²¬í–ˆë‹¤. 

ë‚´ ìƒê°ìœ¼ë¡œëŠ” questioní…Œì´ë¸”ì„ ì¡°íšŒí•  ë•Œ commentì™€ question_hash_tagë¥¼ ì¡°ì¸í•´ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ì¤„ ì•Œì•˜ë‹¤. 

í•œë²ˆ ì¿¼ë¦¬ë¥¼ ë¶„ì„í•´ë³´ì

```sql
Hibernate: 
    /* <criteria> */ select
        q1_0.question_no,
        q1_0.comment_count,
        q1_0.enroll_date,
        q1_0.member_no,
        q1_0.question_content,
        q1_0.question_title,
        q1_0.view_count,
        q1_0.writer 
    from
        question q1_0 
    order by
        q1_0.enroll_date desc 
    limit
        ?, ?
```

ì²«ë²ˆì§¸ ì¿¼ë¦¬ëŠ” ìµœì‹  ë“±ë¡ì¼ ìˆœì„œë¡œ ì •ë ¬í•˜ì—¬ í˜ì´ì§•ì²˜ë¦¬ëœ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

<br>

```sql
Hibernate: 
  /* <criteria> */ select
      count(q1_0.question_no) 
  from
      question q1_0
```

ë‘ë²ˆì§¸ ì¿¼ë¦¬ëŠ” í˜ì´ì§• ì²˜ë¦¬ì— í•„ìš”í•œ ê²Œì‹œê¸€ì˜ ê°œìˆ˜ë¥¼ êµ¬í•˜ëŠ” ì¿¼ë¦¬ì´ë‹¤.

<br>

```sql
Hibernate: 
    select
        cl1_0.question_no,
        cl1_0.comment_no,
        cl1_0.comment_content,
        cl1_0.enroll_date,
        cl1_0.member_no,
        m1_0.member_no,
        m1_0.member_address,
        m1_0.member_birth,
        m1_0.member_email,
        m1_0.member_gender,
        m1_0.member_id,
        m1_0.member_name,
        m1_0.member_nickname,
        m1_0.member_phone,
        m1_0.member_profile,
        m1_0.member_pwd,
        st1_0.skin_no,
        st1_0.skin_name 
    from
        comment cl1_0 
    left join
        member m1_0 
            on m1_0.member_no=cl1_0.member_no 
    left join
        skin_type st1_0 
            on st1_0.skin_no=m1_0.skin_id 
    where
        cl1_0.question_no=?
```

ì„¸ë²ˆì§¸ ì¿¼ë¦¬ë¶€í„° ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
ì´ ì¿¼ë¦¬ëŠ” íŠ¹ì • ê²Œì‹œê¸€ì— ëŒ€í•œ ëª¨ë“  ëŒ“ê¸€ê³¼ ê° ëŒ“ê¸€ì„ ì‘ì„±í•œ íšŒì›ì˜ ì •ë³´ë¥¼ í•¨ê»˜ ì¡°íšŒí•œë‹¤.
ë‚´ê°€ í•„ìš”í•œ ì •ë³´ëŠ” íŠ¹ì • ê²Œì‹œê¸€ì— ë‹¬ë¦° ëŒ“ê¸€ì˜ ê°¯ìˆ˜ë§Œ í•„ìš”í•œê²ƒì¸ë° ë¶ˆí•„ìš”í•œ ì •ë³´ê¹Œì§€ ì¡°íšŒí•œë‹¤.

<br>

```sql
Hibernate: 
    select
        tl1_0.question_no,
        tl1_0.question_hashtag_no,
        ht1_0.hashtag_no,
        ht1_0.hashtag_name 
    from
        question_hash_tag tl1_0 
    left join
        hash_tag ht1_0 
            on ht1_0.hashtag_no=tl1_0.hashtag_no 
    where
        tl1_0.question_no=?
```

ë„¤ë²ˆì§¸ ì¿¼ë¦¬ëŠ” íŠ¹ì • ê²Œì‹œê¸€ì— ëŒ€í•œ ëª¨ë“  í•´ì‹œíƒœê·¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
ì´í›„ì˜ ì¿¼ë¦¬ëŠ” 10ê°œì˜ ê²Œì‹œê¸€ì— ëŒ€í•œ ëŒ“ê¸€ ì¿¼ë¦¬ì™€ í•´ì‹œíƒœê·¸ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•œë‹¤.

í•œë²ˆ ê²Œì‹œê¸€ì„ ì¡°íšŒí• ë•Œ  **(ê²Œì‹œê¸€ ì¡°íšŒ ì¿¼ë¦¬ X ëŒ“ê¸€ ì¡°íšŒ ì¿¼ë¦¬ X í•´ì‹œíƒœê·¸ ì¡°íšŒ ì¿¼ë¦¬)** ê°€ ë°œìƒí•œë‹¤.
ê²Œì‹œê¸€ì„ ì „ì²´ ì¡°íšŒí•  ë•Œ ë§ˆë‹¤ í•œ í˜ì´ì§€ì— ë³´ì´ëŠ” ëª¨ë“  ê²Œì‹œê¸€ê³¼ ì—°ê´€ëœ ëŒ“ê¸€ê³¼ í•´ì‹œíƒœê·¸ë¥¼ ëª¨ë‘ ì¡°íšŒí•œë‹¤. 
ì´ë ‡ê²Œ 1ë²ˆ ì¡°íšŒí•´ì•¼í•  ê²ƒì„ Nê°œ ì¢…ë¥˜ì˜ ë°ì´í„°ë¥¼ ê°ê°ì„ ì¶”ê°€ë¡œ ì¡°íšŒí•˜ëŠ” ë¬¸ì œë¥¼ **N+1ë¬¸ì œ** ë¼ê³  í•œë‹¤.

<br><br>

## í•´ê²° ë°©ë²•

Questionê³¼ ì—°ê´€ëœ QuestionHashTagì™€ CommentëŠ” ëª¨ë‘ `@OneToMany`ë¡œ ì—°ê´€ê´€ê³„ê°€ ë§ºì–´ì ¸ ìˆë‹¤.

```sql
public class Question {
	
	// ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ìƒëµ
	
	
	@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
	private List<QuestionHashTag> tagList = new ArrayList<>();
	
	@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
	private List<Comment> commentList;

}
```

`@OneToMany`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì—° ë¡œë”© ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.(Lazy loading) 

ì§€ì—° ë¡œë”© ë°©ì‹ì€ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œê¹Œì§€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ì§€ ì•Šê³ , í•„ìš”í•  ë•Œ ê°€ì ¸ì˜¤ë„ë¡ í•˜ëŠ” ë°©ì‹ì´ë‹¤.

ë”°ë¼ì„œ ê²Œì‹œê¸€ì˜ ëŒ€í•œ ëŒ“ê¸€ê³¼ í•´ì‹œíƒœê·¸ë“¤ì´ í•„ìš”í•œ ì‹œê¸°ì— ì¿¼ë¦¬ë¥¼ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— N+1ì´ ë°œìƒí–ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ê²Œì‹œê¸€ì„ ì¡°íšŒí• ë•Œ ì—°ê´€ëœ ë°ì´í„°ë¥¼ ëª¨ì¡°ë¦¬ ì¡°íšŒí•˜ëŠ” ì¦‰ì‹œì¡°íšŒ(Eager Loading)ìœ¼ë¡œ ë³€ê²½í•˜ë©´ í•´ê²° ë ê¹Œ?

<br><br>

### ì¦‰ì‹œì¡°íšŒ

```java
@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true, fetch = FetchType.EAGER)
private List<QuestionHashTag> tagList = new ArrayList<>();

@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true, fetch = FetchType.EAGER)
private List<Comment> commentList;
```

`fetch = FetchType.EAGER` ë¥¼ ì‚¬ìš©í•´ ì¦‰ì‹œë¡œë”©ìœ¼ë¡œ ë°”ê¿”ì£¼ì—ˆë‹¤.

ì‹¤í–‰í•´ë³´ì

```sql
Hibernate: 
    /* <criteria> */ select
        q1_0.question_no,
        q1_0.comment_count,
        q1_0.enroll_date,
        q1_0.member_no,
        q1_0.question_content,
        q1_0.question_title,
        q1_0.view_count,
        q1_0.writer 
    from
        question q1_0 
    order by
        q1_0.enroll_date desc 
    limit
        ?, ?
Hibernate: 
    select
        tl1_0.question_no,
        tl1_0.question_hashtag_no,
        ht1_0.hashtag_no,
        ht1_0.hashtag_name 
    from
        question_hash_tag tl1_0 
    left join
        hash_tag ht1_0 
            on ht1_0.hashtag_no=tl1_0.hashtag_no 
    where
        tl1_0.question_no=?
Hibernate: 
    select
        cl1_0.question_no,
        cl1_0.comment_no,
        cl1_0.comment_content,
        cl1_0.enroll_date,
        cl1_0.member_no,
        m1_0.member_no,
        m1_0.member_address,
        m1_0.member_birth,
        m1_0.member_email,
        m1_0.member_gender,
        m1_0.member_id,
        m1_0.member_name,
        m1_0.member_nickname,
        m1_0.member_phone,
        m1_0.member_profile,
        m1_0.member_pwd,
        st1_0.skin_no,
        st1_0.skin_name 
    from
        comment cl1_0 
    left join
        member m1_0 
            on m1_0.member_no=cl1_0.member_no 
    left join
        skin_type st1_0 
            on st1_0.skin_no=m1_0.skin_id 
    where
        cl1_0.question_no=?
        
// ì¶”ê°€ ì¿¼ë¦¬ ë°˜ë³µ
```

ì•„ì‰½ê²Œë„ ì´ì „ê³¼ ë˜‘ê°™ì´ N+1ì´ ë°œìƒí•œë‹¤.

ì´ìœ ëŠ” JPQLì—ì„œ ë°œìƒí•œë‹¤. 

```java
Page<Question> questionPage = questionRepository.findAll(pageable); // ëª¨ë“  ê²Œì‹œê¸€ ì¡°íšŒ
```

JPQLì˜ findAll()ì„ ì‚¬ìš©í–ˆëŠ”ë° ë‚´ë¶€ì ìœ¼ë¡œ `select q from Question q;` ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•œë‹¤.

ì¦‰ Question ì¡°íšŒ ì¿¼ë¦¬ë¬¸ê³¼ ì¦‰ì‹œ ë¡œë”©ì´ ê±¸ë ¤ìˆëŠ” ëŒ“ê¸€ê³¼ í•´ì‹œíƒœê·¸ëŠ” ë”°ë¡œ ì¿¼ë¦¬ë¬¸ì´ ë°œìƒí•œë‹¤.


JPQLì€ ë‚´ë¶€ì—ì„œ joinì„ í•˜ì§€ì•Šê³  ìš°ì„ ì ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ë‹¤ ë³´ë‹ˆ ì—°ê´€ê´€ê³„ê°€ ê±¸ë ¤ìˆì–´ë„ joinì´ ë°”ë¡œ ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

<br>

ê·¸ë ‡ë‹¤ë©´ ë‚´ê°€ JPQLì— ëª…ì‹œì ìœ¼ë¡œ joinì„ ì‘ì„±í•´ì£¼ë©´ í•´ê²°ë ê¹Œ?

<br><br>

### fetch join

JPQLì—ì„œ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì œê³µí•˜ëŠ” ì¡°ì¸ì˜ ì¢…ë¥˜ì´ë‹¤.


<br>

```
â“ ì¼ë°˜ joinê³¼ fetch joinì˜ ì°¨ì´
ì¼ë°˜ joinì€ ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•  ë•Œë§ˆë‹¤ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³ , 
fetch joinì€ ì¦‰ì‹œ ë¡œë”©ì„ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆì— ëª¨ë“  ë°ì´í„°ë¥¼ ë¡œë“œí•œë‹¤.
ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì¼ë°˜ joinì„ ì‚¬ìš©í•˜ë©´ N+1ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```

<br>

```java
@Query("SELECT DISTINCT q FROM Question q " +
       "LEFT JOIN FETCH q.questionHashTags qt" +
       "LEFT JOIN FETCH pt.hashTag" +
       "LEFT JOIN FETCH q.comments")
Page<Question> findAllQuestionsWithTagsAndComments(Pageable pageable);
```

Join ë’¤ì— `Fetch` í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ ì‚¬ìš©í•œë‹¤. ê·¸ë¦¬ê³  ì¤‘ë³µëœ ê²°ê³¼ë¥¼ ì œê±°í•˜ê¸° ìœ„í•´ `DISTINCT` ë¥¼ ë¶™ì—¬ì¤¬ë‹¤.

<br><br>

`@EntityGraph`ë¥¼ ì‚¬ìš©í•´ì„œ fetch joinì„ í•  ìˆ˜ ìˆë‹¤.

```java
@EntityGraph(attributePaths = {"questionHashTags.hashTag","comments"})
Page<Question> findAllQuestionsWithTagsAndComments(Pageable pageable);
```

`@EntityGraph`ì˜Â `attributePaths`ì— ì¿¼ë¦¬ ìˆ˜í–‰ì‹œ ë°”ë¡œ ê°€ì ¸ì˜¬ í•„ë“œëª…ì„ ì§€ì •í•˜ë©´ Lazyê°€ ì•„ë‹Œ Eager ì¡°íšŒë¡œ ê°€ì ¸ì˜¤ê²Œ ëœë‹¤. JPQLì„ ì‚¬ìš©í•˜ëŠ”ê²ƒë³´ë‹¤ ì‘ì„±í•˜ëŠ”ê²Œ ê°„í¸í•˜ë‹¤.

<br>

í•œë²ˆ ì‹¤í–‰í•´ ë³´ì

![Untitled](/assets/img/JPA/n+1(4).png)

<br>

ì´ë²ˆì—ëŠ” ì˜ˆì™¸ê°€ ë°œìƒí–ˆë‹¤.

<br>

```sql
hibernate.loader.MultipleBagFetchException: cannot simultaneously fetch multiple bags
```


`MultipleBagFetchException`ì€ Hibernateì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¡œ, ì¿¼ë¦¬ê°€ ë™ì‹œì— ì—¬ëŸ¬ê°œì˜ bagì»¬ë ‰ì…˜ì„ ê°€ì ¸ì˜¤ë ¤ëŠ” ì‹œë„ë¥¼ ê°€ì ¸ì˜¤ë ¤ëŠ” ê²½ìš° ì‚¬ìš©ë˜ëŠ” ì˜ˆì™¸ë¼ê³  í•œë‹¤.

<br>

```
ğŸ’¡ bag ì»¬ë ‰ì…˜ì´ë€?
ì¤‘ë³µì„ í—ˆìš©í•˜ê³  ìˆœì„œê°€ ì €ì¥ë˜ì§€ ì•Šì€ ì»¬ë ‰ì…˜.
í•˜ì§€ë§Œ ìë°”ì—ì„œëŠ” bag ì»¬ë ‰ì…˜ì´ ì—†ì–´ Listë¥¼ ì‚¬ìš©í•œë‹¤.
```
<br>

ë” ìì„¸íˆ ë§í•˜ë©´ ë³µìˆ˜ì˜ ì»¬ë ‰ì…˜ì„ fetch joiní•´ì„œ ì¡°íšŒí•˜ë ¤í•˜ë©´ ì¹´í…Œì‹œì•ˆ ê³±ì— ì˜í•´ ì¤‘ë³µ ë°ì´í„°ê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë–„ë¬¸ì´ë‹¤. ì¹´í…Œì‹œì•ˆ ê³±ì€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë§¤ìš° ë§ì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ ë˜ì–´ ì„±ëŠ¥ê³¼ ë©”ëª¨ë¦¬ ì‚¬ìš©ì— ë¶€ë‹´ì„ ì¤„ ìˆ˜ìˆê¸° ë•Œë¬¸ì— HibernateëŠ” ì´ëŸ¬í•œ ìƒí™©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ `MultipleBagFetchException`ì„ ë˜ì§„ë‹¤.

<br>

```
ğŸ’¡ ì¹´í…Œì‹œì•ˆ ê³±ì´ë€?
í…Œì´ë¸”ì— ëŒ€í•œ ëª¨ë“  ë°ì´í„°ë¥¼ ì „ë¶€ ê²°í•©í•˜ì—¬ Tableì— ì¡´ì¬í•˜ëŠ” í–‰ ê°¯ìˆ˜ë¥¼ ê³±í•œ ë§Œí¼ì˜ ê²°ê³¼ê°’ì´ ë°˜í™˜ë˜ëŠ” ê²ƒ
```

<br>

ë‚´ ê²½ìš°ì—ëŠ” `questionHastags`ì™€ `comments`  List ì»¬ë ‰ì…˜ 2ê°œë¥¼ ì¡°íšŒí•˜ë ¤ë‹¤ ë³´ë‹ˆ ì¹´í…Œì‹œì•ˆ ê³±ì´ ë°œìƒí• ìˆ˜ ìˆì–´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ê²ƒì´ë‹¤.

```java
@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
private List<QuestionHashTag> questionHastags;
    
@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
private List<Comment> comments;
```

<br><br>


### MultipleBagFetchException í•´ê²°ë²•

<br>

**Setìœ¼ë¡œ ë³€ê²½í•˜ê¸°**

ì•„ì£¼ ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œëŠ” Listë¥¼ Setìœ¼ë¡œ ë³€ê²½í•˜ë©´ `MultipleBagFetchException`ë¥¼  ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
Setì€ ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¹´í…Œì‹œì•ˆ ê³±ì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.


í•œë²ˆ ë³€ê²½í•´ë³´ì

```java
@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
private Set<QuestionHashTag> questionHastags;
    
@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
private Set<Comment> comments;
```

<br>

ì»¬ë ˆì…˜ë“¤ì„ Setìœ¼ë¡œ ë³€ê²½í•˜ê³  ì‹¤í–‰í•´ë³´ì•˜ë‹¤.

```java
2024-07-14T14:54:42.477+09:00  WARN 25880 --- [nio-9090-exec-1] org.hibernate.orm.query                  
: HHH90003004: firstResult/maxResults specified with collection fetch; applying in memory
Hibernate: 
    /* SELECT
        DISTINCT q 
    FROM
        Question q 
    LEFT JOIN
        
    FETCH
        q.questionHashTags qt 
    LEFT JOIN
        
    FETCH
        qt.hashTag 
    LEFT JOIN
        
    FETCH
        q.comments 
    order by
        q.enrollDate desc */ select
            distinct q1_0.question_no,
            q1_0.comment_count,
            c1_0.question_no,
            c1_0.comment_no,
            c1_0.comment_content,
            c1_0.enroll_date,
            c1_0.member_no,
            q1_0.enroll_date,
            q1_0.member_no,
            q1_0.question_content,
            qht1_0.question_no,
            qht1_0.question_hashtag_no,
            ht1_0.hashtag_no,
            ht1_0.hashtag_name,
            q1_0.question_title,
            q1_0.view_count,
            q1_0.writer 
        from
            question q1_0 
        left join
            question_hash_tag qht1_0 
                on q1_0.question_no=qht1_0.question_no 
        left join
            hash_tag ht1_0 
                on ht1_0.hashtag_no=qht1_0.hashtag_no 
        left join
            comment c1_0 
                on q1_0.question_no=c1_0.question_no 
        order by
            q1_0.enroll_date desc
            
// ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ    
```

ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•Šê³  joinì´ ì˜ëœê²ƒì²˜ëŸ¼ ë³´ì¸ë‹¤. í•˜ì§€ë§Œ ìì„¸íˆ ë³´ë©´ í˜ì´ì§• ì²˜ë¦¬ë¥¼ ìœ„í•œ limit êµ¬ë¬¸ì´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

ê²°ê³¼ì°½ì— hibernateê°€ ê²½ê³ ë¬¸ì„ ë³´ì—¬ì£¼ëŠ”ë°

```java
2024-07-14T14:54:42.477+09:00  WARN 25880 --- [nio-9090-exec-1] org.hibernate.orm.query                  
: HHH90003004: firstResult/maxResults specified with collection fetch; applying in memory
```

ì»¬ë ‰ì…˜ fetchë¥¼ í†µí•œ ê²°ê³¼ë¥¼ ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§•ì²˜ë¦¬ë¥¼ í•œë‹¤ëŠ” ëœ»ì´ë‹¤.

ë‹¤ì‹œ ë§í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” ëª¨ë“  ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ê³  ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§• ì²˜ë¦¬ë¥¼ í•œë‹¤ëŠ” ëœ»ì´ë‹¤. ë§Œì•½ ë°ì´í„° ë² ì´ìŠ¤ì— ê²Œì‹œê¸€ì´ 100ë§Œê°œ ìˆë‹¤ê³  ê°€ì •í•˜ë©´ 100ë§Œê°œì˜ ê²Œì‹œê¸€ì„ ë©”ëª¨ë¦¬ë¡œ ë¶ˆëŸ¬ì™€ í˜ì´ì§• ì²˜ë¦¬ë¥¼ í• í…ë° ê·¸ë ‡ë‹¤ë©´ OOMì´ ë°œìƒí•  ê²ƒ ì´ë‹¤.
ì´ë¥¼ hibernateì—ì„œ ê²½ê³ í•´ì£¼ëŠ”ê²ƒì´ë‹¤.


paginationì„ ì‚¬ìš©í•  ê²½ìš°ì—ëŠ” fetch joinì„ í•¨ê»˜ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.
ê²°êµ­ êµ¬ê¸€ë§ì„ í†µí•´ `@BatchSize` ë¼ëŠ” ê±¸ ì•Œì•„ëƒˆë‹¤.

<br><br>

### BatchSize

`BatchSize`ëŠ” JPAì—ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ë°°ì¹˜ë¡œ ë¡œë”©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì´ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ê²ƒìœ¼ë¡œ ì—¬ëŸ¬ ê°œì˜ `SELECT` ì¿¼ë¦¬ë¥¼ ë‹¨ì¼ `IN` ì¿¼ë¦¬ë¡œ ë³€í™˜í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”í•œë‹¤.

`@BatchSize`ë¥¼ ì„¤ì •í•˜ë©´ ì„¤ì •í•œ í¬ê¸°ë§Œí¼ì˜ ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ë¡œë“œí•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

```java
@BatchSize(size = 10)
@OneToMany(mappedBy = "question" ,cascade=CascadeType.ALL , orphanRemoval = true)
private List<QuestionHashTag> questionHashTags;

@BatchSize(size = 10)
@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval = true)
private List<Comment> comments;
```

í•œ í˜ì´ì§€ì— ê²Œì‹œê¸€ì˜ ê°¯ìˆ˜ëŠ” 10ê°œì´ë¯€ë¡œ sizeë¥¼ 10ìœ¼ë¡œ ì„¤ì •í•´ ì£¼ì—ˆë‹¤.

<br>

ì´ì œ ì‹¤í–‰í•´ë³´ë©´

```java
Hibernate: 
    /* <criteria> */ select
        q1_0.question_no,
        q1_0.comment_count,
        q1_0.enroll_date,
        q1_0.member_no,
        q1_0.question_content,
        q1_0.question_title,
        q1_0.view_count,
        q1_0.writer 
    from
        question q1_0 
    order by
        q1_0.enroll_date desc 
    limit
        ?, ?
Hibernate: 
    /* <criteria> */ select
        count(q1_0.question_no) 
    from
        question q1_0
Hibernate: 
    select
        qht1_0.question_no,
        qht1_0.question_hashtag_no,
        ht1_0.hashtag_no,
        ht1_0.hashtag_name 
    from
        question_hash_tag qht1_0 
    left join
        hash_tag ht1_0 
            on ht1_0.hashtag_no=qht1_0.hashtag_no 
    where
        qht1_0.question_no in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    select
        c1_0.question_no,
        c1_0.comment_no,
        c1_0.comment_content,
        c1_0.enroll_date,
        c1_0.member_no,
        m1_0.member_no,
        m1_0.member_address,
        m1_0.member_birth,
        m1_0.member_email,
        m1_0.member_gender,
        m1_0.member_id,
        m1_0.member_name,
        m1_0.member_nickname,
        m1_0.member_phone,
        m1_0.member_profile,
        m1_0.member_pwd,
        st1_0.skin_no,
        st1_0.skin_name 
    from
        comment c1_0 
    left join
        member m1_0 
            on m1_0.member_no=c1_0.member_no 
    left join
        skin_type st1_0 
            on st1_0.skin_no=m1_0.skin_id 
    where
        c1_0.question_no in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

// ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ
```

ì •ìƒì ìœ¼ë¡œ í˜ì´ì§• ì²˜ë¦¬ê°€ ë˜ì—ˆê³  í•´ì‹œíƒœê·¸ì™€ ëŒ“ê¸€ì— `in`  ì„ ì‚¬ìš©í•´ í•œë²ˆì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
ë¬´ì—‡ë³´ë‹¤ ì¶”ê°€ ì¿¼ë¦¬ê°€ ì—†ì–´ì¡Œë‹¤.

ì´ë ‡ê²Œ ë‹¤ì–‘í•œ N+1ì„ í•´ê²°í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ì°¾ì•„ë´¤ë‹¤.
ë§Œì•½ í˜ì´ì§• ì²˜ë¦¬ê°€ í•„ìš”ì—†ëŠ” ì‘ì—…ì´ì—ˆë‹¤ë©´ Fetch joinìœ¼ë¡œ í•´ê²°ì´ ê°€ëŠ¥í•  ê²ƒì´ë‹¤.

ì´ë ‡ê²Œ í˜ì´ì§• ì²˜ë¦¬ì™€ ì»¬ë ‰ì…˜ì„ 2ê°œì´ìƒ ì‚¬ìš©í•œë‹¤ë©´ `BatchSize`ë¥¼ ì‚¬ìš©í•´ í•œë²ˆì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ N+1ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.


<br><br>

ì¶”ê°€ë¡œ commentë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë³´ë©´

```java
Hibernate: 
    select
        c1_0.question_no,
        c1_0.comment_no,
        c1_0.comment_content,
        c1_0.enroll_date,
        c1_0.member_no,
        m1_0.member_no,
        m1_0.member_address,
        m1_0.member_birth,
        m1_0.member_email,
        m1_0.member_gender,
        m1_0.member_id,
        m1_0.member_name,
        m1_0.member_nickname,
        m1_0.member_phone,
        m1_0.member_profile,
        m1_0.member_pwd,
        st1_0.skin_no,
        st1_0.skin_name 
    from
        comment c1_0 
    left join
        member m1_0 
            on m1_0.member_no=c1_0.member_no 
    left join
        skin_type st1_0 
            on st1_0.skin_no=m1_0.skin_id 
    where
        c1_0.question_no in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

```

ë‚˜ëŠ” ê²Œì‹œê¸€ì˜ ëŒ€í•œ ëŒ“ê¸€ ê°¯ìˆ˜ë§Œ í•„ìš”í•œê²ƒ ë¿ì¸ë° í•„ìš”í•˜ì§€ë„ ì•Šì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

<br>

ëŒ“ê¸€ì˜ ê°¯ìˆ˜ë¥¼ ë§¤í•‘ ì»¬ë ‰ì…˜ì˜ `size()` ë¡œ êµ¬í–ˆê¸° ë•Œë¬¸ì— JPAê°€ commentì˜ ì—”í‹°í‹°ì—ì ‘ê·¼í•´ í•„ìš”ì—†ëŠ” ë°ì´í„°ê¹Œì§€ ëª¨ì¡°ë¦¬ ê°€ì ¸ì˜¨ê²ƒì„ ë°œê²¬í–ˆë‹¤.

```java
// serviceë‹¨

int commentCount = question.getComments().size(); // ë§¤í•‘ ì»¬ë ‰ì…˜ì— ì ‘ê·¼

return QuestionResponse.builder()
        .questionNo(question.getQuestionNo())
        .questionTitle(question.getQuestionTitle())
        .questionContent(question.getQuestionContent())
        .viewCount(question.getViewCount())
        .writer(question.getWriter())
        .enrollDate(question.getEnrollDate())
        .tagList(question.getQuestionHashTags())
        .commentCount(commentCount) 
        .build();
}
```

ê·¸ë˜ì„œ ë§¤í•‘ ì»¬ë ‰ì…˜ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²• ë§ê³  ì„œë¸Œì¿¼ë¦¬ë¡œ ëŒ“ê¸€ì˜ ê°¯ìˆ˜ë§Œ ê°€ì ¸ì˜¬ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ìƒê°í•´ë´¤ë‹¤.
<br>

```java
//@BatchSize(size = 10)
@OneToMany(mappedBy = "question",cascade=CascadeType.ALL , orphanRemoval =true)
private List<Comment> comments;

@Formula("(select count(*) from comment c where c.question_no = QUESTION_NO)")
private int commentCount;
```

`@Formula` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ ê²Œì‹œê¸€ ì¡°íšŒì‹œ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤¬ë‹¤.

<br>

ì„œë¹„ìŠ¤ë‹¨ ì½”ë“œë„ ìˆ˜ì •í•´ì¤¬ë‹¤.

```java
//int commentCount = question.getComments().size();

return QuestionResponse.builder()
        .questionNo(question.getQuestionNo())
        .questionTitle(question.getQuestionTitle())
        .questionContent(question.getQuestionContent())
        .viewCount(question.getViewCount())
        .writer(question.getWriter())
        .enrollDate(question.getEnrollDate())
        .tagList(question.getQuestionHashTags())
        .commentCount(question.getCommentCount()) // ì„œë¸Œì¿¼ë¦¬ë¥¼ í†µí•´ ëŒ“ê¸€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        .build();
}
```

<br>

ì´ì œ ë‹¤ì‹œ ê²Œì‹œê¸€ ì¡°íšŒë¥¼ í•´ë³´ë©´

```SQL
Hibernate: 
    /* <criteria> */ select
        q1_0.question_no,
        (select --ì„œë¸Œì¿¼ë¦¬ë¡œ ëŒ“ê¸€ê°¯ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            count(*) 
        from
            comment c 
        where
            c.question_no = q1_0.QUESTION_NO),
        q1_0.enroll_date,
        q1_0.member_no,
        q1_0.question_content,
        q1_0.question_title,
        q1_0.view_count,
        q1_0.writer 
    from
        question q1_0 
    order by
        q1_0.enroll_date desc 
    limit
        ?, ?
Hibernate: 
    /* <criteria> */ select
        count(q1_0.question_no) 
    from
        question q1_0
Hibernate: 
    select
        qht1_0.question_no,
        qht1_0.question_hashtag_no,
        ht1_0.hashtag_no,
        ht1_0.hashtag_name 
    from
        question_hash_tag qht1_0 
    left join
        hash_tag ht1_0 
            on ht1_0.hashtag_no=qht1_0.hashtag_no 
    where
        qht1_0.question_no in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        
// ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ       
```

ì¡°íšŒì‹œ ë°œìƒí•œ ì¿¼ë¦¬ê°€ í™•ì—°í•˜ê²Œ ì¤„ì–´ë“ ê²Œ ë³´ì¸ë‹¤.
ê²Œì‹œê¸€ì— ë‹¬ë¦° ëŒ“ê¸€ì˜ ê°¯ìˆ˜ëŠ” `@Fomula`ì„œë¸Œì¿¼ë¦¬ë¥¼ í†µí•´ ì¡°íšŒí–ˆê³  í•´ì‹œíƒœê·¸ëŠ” `@BatchSize`ë¥¼ ì‚¬ìš©í•´ì„œ í•œë²ˆì— ì¡°íšŒí•´ì™”ë‹¤.


<br>

ë§ˆì§€ë§‰ìœ¼ë¡œ í¬ìŠ¤íŠ¸ë§¨ì„ ì‚¬ìš©í•´ì„œ ìš”ì²­ 1000 ê°œë¥¼ ë‚ ë ¤ ê°œì„  ì „ê³¼ í›„ë¥¼ ë¹„êµí•´ë³´ê² ë‹¤.

## ê²°ê³¼

<br>

**ê°œì„  ì „**

![Untitled](/assets/img/JPA/n+1(5).png)

**ê°œì„  í›„**

![Untitled](/assets/img/JPA/n+1(6).png)

1000ê°œë¥¼ ëª¨ë‘ ë‚ ë¦¬ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ ë¹„ìŠ·í•˜ì§€ë§Œ í•œ ê°œì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ”ë°ì— ê±¸ë¦¬ëŠ”ì†ë„ëŠ” 2ë°° ì •ë„ ì°¨ì´ê°€ ë‚œë‹¤. 




<br>
ì„œë¸Œì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ìƒ ì•ˆì¢‹ë‹¤ëŠ”ê±¸ ë“¤ì—ˆë‹¤.ì´ í›„ì—ëŠ” ì„œë¸Œì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ countë¥¼ êµ¬í•˜ëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ê² ë‹¤.


<br><br><br><br><br>

### Reference
https://jojoldu.tistory.com/457
https://www.inflearn.com/course/lecture?courseSlug=ORM-JPA-Basic&unitId=21743
https://velog.io/@jinyoungchoi95/JPA-%EB%AA%A8%EB%93%A0-N1-%EB%B0%9C%EC%83%9D-%EC%BC%80%EC%9D%B4%EC%8A%A4%EA%B3%BC-%ED%95%B4%EA%B2%B0%EC%B1%85#%EC%A6%89%EC%8B%9C%EB%A1%9C%EB%94%A9